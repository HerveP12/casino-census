<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Floor Census</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        input, select, textarea { color: white; }
        input::placeholder { color: rgba(255,255,255,0.5); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
<div id="app" class="max-w-5xl mx-auto p-4"></div>

<script>
// =====================================================
// CONFIGURATION - UPDATE THESE VALUES
// =====================================================
const CONFIG = {
    // Your Microsoft Form URL (the share link)
    FORM_URL: 'https://forms.office.com/Pages/ResponsePage.aspx?id=-umvo6-mSUCw4wWmSnrbd3s74at45IxLkYKqhgS9USpUOTdUTjVWMlAyS0JFUVJNUlhQQzlGNzIzTC4u',
    
    // Your JSON file URL from SharePoint
    DATA_URL: 'https://lightnwonder-my.sharepoint.com/:u:/g/personal/hparent_lnw_com/IQBuxvZYKYDoRLfGbdM8ligNASNWrZNesJAFaRZg_DT11LM?e=ZPWPTL',
    
    // Field IDs from your Form (get these from Step 2)
    FIELDS: {
        ActionType: 'rf600c20ddb26480ab6a386cd55c39df7',
        PropertyID: 're5095e04648249838831319b977f8fb6',
        PropertyName: 'r281f2d3b77dc4abb828d24b2eb7d7e96',
        PropertyLocation: 'r3e4548339a1c49b3b7fe8e6ef7f41cd1',
        CompetitiveSet: 'r7c4a5e2d4d0f4c7080ceba8f190294f6',
        CreatedBy: 'rc6ee37856be44619a9dd04e70f685661',
        CreatedDate: 'r2096eac2fafb40928b06f7e2fd05f367',
        VersionID: 'rae63ef189c4e408b919e918882af8c80',
        Surveyor: 'r8b668d301940429a89f83fe90bff29de',
        VersionDate: 'rf121ac69d65b49a59a2e002599aa0ae1',
        EntryID: 'r450b02554a0a41f8b9a16a0a322af671',
        Section: 'r81c424e37b8646478407194356ad7de6',
        Category: 'rb3e588bcb3f848da85a4d8deb0dd91b0',
        Subcategory: 'r23b6331d33c94c8d981adfb3d241bb75',
        Vendor: 'raee437eccc2743a98c08f5b395e3ee21',
        Count: 'rc4bd7909bc06465980395472baf08114',
        GameType: 'r63890df9292c4a61b7b6b6487a3a1848',
        SideBet: 'ref2b89b523f9415093148f5555b4d7ec',
        Progressive: 'rb1692cbaffba41ae9b2c548df5c64b21',
        EntryType: 'r77cf6d54a04444d0a5b0591004b7557e',
        Configuration: 'r39a43ea344454475af85734a3d29b055',
        SeatCount: 'ra0f10d38cd1c4266bf7e06b34f7b06fe',
        MinBet: 'r51c3e9d1387b4c9abd5d4bcbdd248f4c',
        MaxBet: 'r495e46266ab54fb8b76c50c7eab10329',
        FloorLocation: 'r3b3003ed35ee4246bd0530989c5940df',
        Notes: 'r1490a6f28dec4528ab00f082376fb85f',
        Timestamp: 'r0bad5cfc343f4a0ab84297dc56ab025f'
    }
};
// =====================================================

const template = {
    ptg: [
        { c: 'Carnival', s: 'Poker Etc', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], g: ['Three Card','UTH','Let It Ride'] },
        { c: 'Carnival', s: 'Blackjack', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], sb: ['21+3','Perfect Pairs','Lucky Ladies'], bl: true },
        { c: 'Carnival', s: 'Baccarat', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], sb: ['Dragon Bonus','Panda 8'], bl: true },
        { c: 'Non Card', s: 'Craps', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], bl: true },
        { c: 'Non Card', s: 'Roulette', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], t: ['Single Zero','Double Zero'], bl: true },
        { c: 'Electronics', s: 'Progressives', v: ['LNW','AGS','GLXY','EMP','MCR','NRT','TCS','Everi','Other'], p: {AGS:['Stacks','Bonus Spin'],LNW:['BSX','iTable'],GLXY:['Galaxy Bonus']} }
    ],
    etg: [
        { c: 'Stadium', s: 'Stadium Gaming', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'], cfg: ['Craps','Roulette','Baccarat'], st: ['12-seat','24-seat','36-seat'] },
        { c: 'Terminals', s: 'Standalone', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'], g: ['Blackjack','Baccarat','Roulette'] },
        { c: 'Auto', s: 'Auto Roulette', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'] }
    ],
    util: [
        { c: 'Shufflers', s: 'Poker Shuffler', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'], t: ['Single Deck','Multi Deck'] },
        { c: 'Chip', s: 'Chipper', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'] },
        { c: 'Card', s: 'Shoe', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'], t: ['4-Deck','6-Deck','8-Deck'] },
        { c: 'Signage', s: 'Bacc Signage', v: ['LNW','IB','IGT','Spin Tech','Aruze','IT','Other'], t: ['LED','LCD'] }
    ]
};

let state = {
    properties: [], surveys: [], currentProperty: null, currentStep: 0,
    surveyorName: localStorage.getItem('censusName') || '', currentEntries: {},
    surveyMode: null, selectedVersion: null, loading: true, saving: false, connected: false, lastUpdate: null
};

async function loadData() {
    state.loading = true; render();
    try {
        const res = await fetch(CONFIG.DATA_URL + '?_=' + Date.now(), { credentials: 'include' });
        if (!res.ok) throw new Error('Load failed');
        const data = await res.json();
        state.properties = (data.properties || []).map(p => ({
            PropertyID: p.PropertyID, Name: p.Name || p.Title, Location: p.Location,
            CompetitiveSet: p.CompetitiveSet, CreatedBy: p.CreatedBy, CreatedDate: p.CreatedDate
        }));
        state.surveys = [
            ...(data.versions || []).map(v => ({ ...v, isVersion: true })),
            ...(data.entries || [])
        ];
        state.connected = true;
        state.lastUpdate = data.updated ? new Date(data.updated).toLocaleTimeString() : 'Unknown';
    } catch (e) {
        console.error('Load error:', e);
        state.connected = false;
    }
    state.loading = false; render();
}

async function submitForm(data) {
    const formData = new URLSearchParams();
    Object.keys(data).forEach(key => {
        if (CONFIG.FIELDS[key] && data[key]) {
            formData.append(CONFIG.FIELDS[key], data[key]);
        }
    });
    try {
        await fetch(CONFIG.FORM_URL.replace('/r/', '/formApi/api/v1/forms/') + '/responses', {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        });
        return true;
    } catch (e) {
        console.error('Submit error:', e);
        return false;
    }
}

async function saveProperty(name, location, compSet) {
    const id = 'P' + Date.now();
    await submitForm({
        ActionType: 'saveProperty', PropertyID: id, PropertyName: name,
        PropertyLocation: location, CompetitiveSet: compSet,
        CreatedBy: state.surveyorName, CreatedDate: new Date().toISOString()
    });
    state.properties.push({ PropertyID: id, Name: name, Location: location, CompetitiveSet: compSet });
    state.currentProperty = state.properties[state.properties.length - 1];
    return true;
}

async function saveSurvey() {
    state.saving = true; render();
    const all = Object.values(state.currentEntries).filter(e => e.count > 0);
    const vid = 'V' + Date.now();
    const vdate = new Date().toISOString();
    
    await submitForm({
        ActionType: 'saveVersion', VersionID: vid,
        PropertyID: state.currentProperty.PropertyID, PropertyName: state.currentProperty.Name,
        Surveyor: state.surveyorName, VersionDate: vdate
    });
    
    for (const ent of all) {
        const item = template[ent.section][ent.itemIndex];
        await submitForm({
            ActionType: 'saveEntry', EntryID: 'E' + Date.now() + Math.random().toString(36).substr(2, 4),
            VersionID: vid, PropertyID: state.currentProperty.PropertyID,
            PropertyName: state.currentProperty.Name, Surveyor: state.surveyorName,
            Section: ent.section.toUpperCase(), Category: item.c, Subcategory: item.s,
            Vendor: ent.vendor === 'Other' ? 'Other: ' + ent.otherSpecify : ent.vendor,
            Count: String(ent.count), GameType: ent.gameType || '', SideBet: ent.sideBet || '',
            Progressive: ent.progressive || '', EntryType: ent.type || '',
            Configuration: ent.configuration || '', SeatCount: ent.seatCount || '',
            MinBet: ent.minBet || '', MaxBet: ent.maxBet || '',
            FloorLocation: ent.location || '', Notes: ent.notes || '',
            Timestamp: new Date().toISOString()
        });
        await new Promise(r => setTimeout(r, 100)); // Small delay between submissions
    }
    
    alert('Survey saved successfully!\n\n' + all.length + ' entries submitted.\n\nData will sync within 5 minutes.');
    state.currentStep = 0; state.currentEntries = {}; state.surveyMode = null; state.saving = false;
    render();
}

function getVersions(pid) { return state.surveys.filter(s => s.PropertyID === pid && s.isVersion); }
function getRecent(pid) { const v = getVersions(pid); return v.length ? v.sort((a,b) => new Date(b.VersionDate) - new Date(a.VersionDate))[0] : null; }
function getTotalItems() {
    const latest = {};
    state.surveys.filter(s => s.isVersion).forEach(v => {
        if (!latest[v.PropertyID] || new Date(v.VersionDate) > new Date(latest[v.PropertyID].VersionDate)) latest[v.PropertyID] = v;
    });
    return Object.values(latest).reduce((t, v) => t + state.surveys.filter(s => s.VersionID === v.VersionID && !s.isVersion).reduce((sum, e) => sum + (parseInt(e.Count) || 0), 0), 0);
}

function render() {
    const app = document.getElementById('app');
    if (state.loading) { app.innerHTML = '<div class="flex items-center justify-center h-screen"><div class="text-white text-xl">Loading...</div></div>'; return; }
    
    const secKey = ['','ptg','etg','util'][state.currentStep];
    const secName = ['','PTG - Physical Table Games','ETG - Electronic Table Games','UTIL - Utilities'][state.currentStep];
    const curEntries = Object.values(state.currentEntries).filter(e => e.section === secKey && e.count > 0);
    
    let html = `
    <header class="bg-white/10 backdrop-blur rounded-2xl p-6 mb-6 border border-white/20">
        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">Casino Floor Census</h1>
                <div class="flex items-center gap-3 mt-1">
                    <span class="text-blue-200 text-sm">PTG • ETG • UTIL</span>
                    <span class="text-xs px-2 py-0.5 rounded ${state.connected ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}">${state.connected ? '● Online' : '○ Offline'}</span>
                    ${state.lastUpdate ? `<span class="text-xs text-white/50">Updated: ${state.lastUpdate}</span>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="loadData()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm">↻ Refresh</button>
                <button onclick="exportCSV()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm font-medium">↓ Export CSV</button>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-center">
            <div class="bg-blue-500/20 rounded-xl p-3 border border-blue-400/30">
                <div class="text-2xl font-bold text-white">${state.properties.length}</div>
                <div class="text-xs text-blue-200">Properties</div>
            </div>
            <div class="bg-purple-500/20 rounded-xl p-3 border border-purple-400/30">
                <div class="text-2xl font-bold text-white">${state.surveys.filter(s => s.isVersion).length}</div>
                <div class="text-xs text-purple-200">Surveys</div>
            </div>
            <div class="bg-emerald-500/20 rounded-xl p-3 border border-emerald-400/30">
                <div class="text-2xl font-bold text-white">${getTotalItems()}</div>
                <div class="text-xs text-emerald-200">Items</div>
            </div>
        </div>
    </header>`;
    
    if (state.currentStep === 0) {
        html += `
        <main class="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
            <h2 class="text-xl font-bold text-white mb-4">Start Survey</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-blue-200 mb-1">Your Name</label>
                    <input type="text" id="inpName" value="${state.surveyorName}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Enter your name">
                </div>
                <div>
                    <label class="block text-sm text-blue-200 mb-1">Select Property</label>
                    <select id="selProp" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="">-- Select --</option>
                        ${state.properties.map(p => `<option value="${p.PropertyID}" ${state.currentProperty?.PropertyID === p.PropertyID ? 'selected' : ''}>${p.Name} - ${p.Location}</option>`).join('')}
                    </select>
                </div>
                <button onclick="openAddProperty()" class="w-full bg-blue-500/30 hover:bg-blue-500/50 text-blue-100 rounded-lg py-2.5 text-sm font-medium">+ Add New Property</button>
                <button onclick="startSurvey()" class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white rounded-lg py-3 font-bold text-lg">Start Survey →</button>
            </div>
        </main>`;
    } else {
        const items = template[secKey];
        html += `
        <main class="bg-white/10 backdrop-blur rounded-2xl p-6 border border-white/20">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-lg font-bold text-white">${secName}</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-sm text-blue-200">Step ${state.currentStep}/3</span>
                        <div class="flex gap-1">${[1,2,3].map(i => `<div class="w-8 h-1.5 rounded ${i <= state.currentStep ? 'bg-emerald-500' : 'bg-white/20'}"></div>`).join('')}</div>
                    </div>
                </div>
                <div class="text-sm text-blue-200 bg-blue-500/20 px-3 py-1 rounded-lg">${curEntries.length} entries</div>
            </div>
            <div class="space-y-4">
                ${items.map((item, idx) => `
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <div class="text-white font-medium mb-2">${item.c} → ${item.s}</div>
                    <div class="flex flex-wrap gap-2">
                        ${item.v.map(v => {
                            const k = `${secKey}-${idx}-${v}`;
                            const ent = state.currentEntries[k];
                            const has = ent?.count > 0;
                            return `<button onclick="openDetail('${secKey}',${idx},'${v}')" class="px-3 py-1.5 rounded-lg text-sm ${has ? 'bg-emerald-500 text-white font-medium' : 'bg-white/10 text-blue-200 hover:bg-white/20'}">${v}${has ? ' ('+ent.count+')' : ''}</button>`;
                        }).join('')}
                    </div>
                </div>`).join('')}
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="cancelSurvey()" class="flex-1 bg-white/10 hover:bg-white/20 text-white rounded-lg py-3 font-medium">Cancel</button>
                ${state.currentStep > 1 ? `<button onclick="state.currentStep--;render()" class="flex-1 bg-white/10 hover:bg-white/20 text-white rounded-lg py-3 font-medium">← Back</button>` : ''}
                <button onclick="nextStep()" ${state.saving?'disabled':''} class="flex-1 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-lg py-3 font-bold disabled:opacity-50">${state.saving ? 'Saving...' : state.currentStep === 3 ? 'Complete ✓' : 'Next →'}</button>
            </div>
        </main>`;
    }
    
    // Modals
    html += `
    <div id="modalProperty" class="modal fixed inset-0 bg-black/70 items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md border border-white/20">
            <h3 class="text-lg font-bold text-white mb-4">Add Property</h3>
            <div class="space-y-3">
                <input type="text" id="propName" placeholder="Property Name" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5">
                <input type="text" id="propLoc" placeholder="Location (City, State)" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5">
                <input type="text" id="propSet" placeholder="Competitive Set" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5">
            </div>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('modalProperty')" class="flex-1 bg-white/10 text-white rounded-lg py-2.5">Cancel</button>
                <button onclick="addProperty()" class="flex-1 bg-blue-500 text-white rounded-lg py-2.5 font-medium">Add</button>
            </div>
        </div>
    </div>
    
    <div id="modalDetail" class="modal fixed inset-0 bg-black/70 items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md border border-white/20 my-8">
            <h3 id="detailTitle" class="text-lg font-bold text-white mb-4">Entry Details</h3>
            <div id="detailContent" class="space-y-3"></div>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('modalDetail')" class="flex-1 bg-white/10 text-white rounded-lg py-2.5">Cancel</button>
                <button onclick="saveDetail()" class="flex-1 bg-blue-500 text-white rounded-lg py-2.5 font-medium">Save</button>
            </div>
        </div>
    </div>
    
    <div id="modalVersion" class="modal fixed inset-0 bg-black/70 items-center justify-center z-50 p-4">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-lg border border-white/20 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-white mb-4">Previous Surveys</h3>
            <div id="versionContent"></div>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('modalVersion')" class="flex-1 bg-white/10 text-white rounded-lg py-2.5">Cancel</button>
                <button onclick="newSurvey()" class="flex-1 bg-emerald-500 text-white rounded-lg py-2.5 font-medium">New Survey</button>
            </div>
        </div>
    </div>`;
    
    app.innerHTML = html;
}

let detailCtx = null;
function openDetail(sec, idx, vendor) {
    const item = template[sec][idx];
    const k = `${sec}-${idx}-${vendor}`;
    const ex = state.currentEntries[k] || {};
    detailCtx = { sec, idx, vendor, item, key: k };
    
    document.getElementById('detailTitle').textContent = `${item.c} - ${item.s} (${vendor})`;
    let html = `<div><label class="block text-sm text-blue-200 mb-1">Count</label><input type="number" id="detCount" min="0" value="${ex.count||0}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"></div>`;
    if (vendor === 'Other') html += `<div><label class="block text-sm text-blue-200 mb-1">Vendor Name</label><input type="text" id="detOther" value="${ex.otherSpecify||''}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5" placeholder="Specify vendor"></div>`;
    if (item.g) html += `<div><label class="block text-sm text-blue-200 mb-1">Game Type</label><select id="detGame" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"><option value="">-- Select --</option>${item.g.map(g=>`<option value="${g}" ${ex.gameType===g?'selected':''}>${g}</option>`).join('')}</select></div>`;
    if (item.sb) html += `<div><label class="block text-sm text-blue-200 mb-1">Side Bet</label><select id="detSide" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"><option value="">-- Select --</option>${item.sb.map(s=>`<option value="${s}" ${ex.sideBet===s?'selected':''}>${s}</option>`).join('')}</select></div>`;
    if (item.t) html += `<div><label class="block text-sm text-blue-200 mb-1">Type</label><select id="detType" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"><option value="">-- Select --</option>${item.t.map(t=>`<option value="${t}" ${ex.type===t?'selected':''}>${t}</option>`).join('')}</select></div>`;
    if (item.cfg) html += `<div><label class="block text-sm text-blue-200 mb-1">Configuration</label><select id="detCfg" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"><option value="">-- Select --</option>${item.cfg.map(c=>`<option value="${c}" ${ex.configuration===c?'selected':''}>${c}</option>`).join('')}</select></div>`;
    if (item.st) html += `<div><label class="block text-sm text-blue-200 mb-1">Seat Count</label><select id="detSeats" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5"><option value="">-- Select --</option>${item.st.map(s=>`<option value="${s}" ${ex.seatCount===s?'selected':''}>${s}</option>`).join('')}</select></div>`;
    if (item.bl) html += `<div class="grid grid-cols-2 gap-3"><div><label class="block text-sm text-blue-200 mb-1">Min Bet</label><input type="text" id="detMin" value="${ex.minBet||''}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5" placeholder="$5"></div><div><label class="block text-sm text-blue-200 mb-1">Max Bet</label><input type="text" id="detMax" value="${ex.maxBet||''}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5" placeholder="$500"></div></div>`;
    html += `<div><label class="block text-sm text-blue-200 mb-1">Floor Location</label><input type="text" id="detLoc" value="${ex.location||''}" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5" placeholder="Main floor, Pit 3"></div>`;
    html += `<div><label class="block text-sm text-blue-200 mb-1">Notes</label><textarea id="detNotes" rows="2" class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-2.5">${ex.notes||''}</textarea></div>`;
    
    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('modalDetail').classList.add('active');
}

function saveDetail() {
    const count = parseInt(document.getElementById('detCount').value) || 0;
    const other = document.getElementById('detOther')?.value?.trim() || '';
    if (detailCtx.vendor === 'Other' && count > 0 && !other) { alert('Enter vendor name'); return; }
    
    if (count === 0) { delete state.currentEntries[detailCtx.key]; }
    else {
        state.currentEntries[detailCtx.key] = {
            section: detailCtx.sec, itemIndex: detailCtx.idx, vendor: detailCtx.vendor, count,
            otherSpecify: other, gameType: document.getElementById('detGame')?.value || '',
            sideBet: document.getElementById('detSide')?.value || '', type: document.getElementById('detType')?.value || '',
            configuration: document.getElementById('detCfg')?.value || '', seatCount: document.getElementById('detSeats')?.value || '',
            minBet: document.getElementById('detMin')?.value || '', maxBet: document.getElementById('detMax')?.value || '',
            location: document.getElementById('detLoc')?.value || '', notes: document.getElementById('detNotes')?.value || ''
        };
    }
    closeModal('modalDetail'); render();
}

function startSurvey() {
    const name = document.getElementById('inpName').value.trim();
    const propId = document.getElementById('selProp').value;
    if (!name) { alert('Enter your name'); return; }
    if (!propId) { alert('Select a property'); return; }
    state.surveyorName = name;
    localStorage.setItem('censusName', name);
    state.currentProperty = state.properties.find(p => p.PropertyID === propId);
    
    const versions = getVersions(propId);
    if (versions.length) { showVersions(versions); }
    else { newSurvey(); }
}

function showVersions(versions) {
    let html = '<div class="space-y-3">';
    versions.sort((a,b) => new Date(b.VersionDate) - new Date(a.VersionDate)).forEach(v => {
        const entries = state.surveys.filter(s => s.VersionID === v.VersionID && !s.isVersion);
        const total = entries.reduce((sum, e) => sum + (parseInt(e.Count) || 0), 0);
        html += `<div class="bg-white/5 rounded-lg p-3 border border-white/10">
            <div class="text-white font-medium">${new Date(v.VersionDate).toLocaleDateString()}</div>
            <div class="text-sm text-blue-200">${v.Surveyor} • ${entries.length} entries • ${total} items</div>
            <button onclick="copyVersion('${v.VersionID}')" class="mt-2 w-full bg-purple-500/30 text-purple-200 rounded py-1.5 text-sm">Copy as Template</button>
        </div>`;
    });
    html += '</div>';
    document.getElementById('versionContent').innerHTML = html;
    document.getElementById('modalVersion').classList.add('active');
}

function copyVersion(versionId) {
    const entries = state.surveys.filter(s => s.VersionID === versionId && !s.isVersion);
    state.currentEntries = {};
    entries.forEach(e => {
        const sec = e.Section.toLowerCase();
        const items = template[sec];
        if (!items) return;
        const idx = items.findIndex(i => i.c === e.Category && i.s === e.Subcategory);
        if (idx >= 0) {
            const v = e.Vendor.startsWith('Other:') ? 'Other' : e.Vendor;
            state.currentEntries[`${sec}-${idx}-${v}`] = {
                section: sec, itemIndex: idx, vendor: v, count: parseInt(e.Count) || 0,
                otherSpecify: e.Vendor.startsWith('Other:') ? e.Vendor.replace('Other: ','') : '',
                gameType: e.GameType || '', sideBet: e.SideBet || '', type: e.EntryType || '',
                configuration: e.Configuration || '', seatCount: e.SeatCount || '',
                minBet: e.MinBet || '', maxBet: e.MaxBet || '', location: e.FloorLocation || '', notes: e.Notes || ''
            };
        }
    });
    closeModal('modalVersion');
    state.surveyMode = 'new'; state.currentStep = 1; render();
}

function newSurvey() { closeModal('modalVersion'); state.surveyMode = 'new'; state.currentStep = 1; state.currentEntries = {}; render(); }
function nextStep() {
    if (state.currentStep < 3) { state.currentStep++; render(); }
    else {
        const all = Object.values(state.currentEntries).filter(e => e.count > 0);
        if (!all.length) { alert('Add at least one entry'); return; }
        if (confirm('Submit survey with ' + all.length + ' entries?')) saveSurvey();
    }
}
function cancelSurvey() { if (confirm('Cancel survey?')) { state.currentStep = 0; state.currentEntries = {}; render(); } }

function openAddProperty() { document.getElementById('modalProperty').classList.add('active'); }
async function addProperty() {
    const n = document.getElementById('propName').value.trim();
    const l = document.getElementById('propLoc').value.trim();
    const s = document.getElementById('propSet').value.trim();
    if (!n || !l || !s) { alert('Fill all fields'); return; }
    await saveProperty(n, l, s);
    closeModal('modalProperty');
    document.getElementById('propName').value = '';
    document.getElementById('propLoc').value = '';
    document.getElementById('propSet').value = '';
    render();
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }

function exportCSV() {
    const entries = state.surveys.filter(s => !s.isVersion);
    if (!entries.length) { alert('No data'); return; }
    const rows = [['Property','Location','Surveyor','Date','Section','Category','Subcategory','Vendor','Count','GameType','SideBet','Type','MinBet','MaxBet','FloorLocation','Notes']];
    entries.forEach(e => {
        const p = state.properties.find(x => x.PropertyID === e.PropertyID);
        rows.push([e.PropertyName, p?.Location||'', e.Surveyor, e.Timestamp||'', e.Section, e.Category, e.Subcategory, e.Vendor, e.Count, e.GameType||'', e.SideBet||'', e.EntryType||'', e.MinBet||'', e.MaxBet||'', e.FloorLocation||'', `"${(e.Notes||'').replace(/"/g,'""')}"`]);
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    a.download = 'casino_census_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}

loadData();
</script>
</body>
</html>
